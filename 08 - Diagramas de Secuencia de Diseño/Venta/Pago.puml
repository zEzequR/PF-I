@startuml
!pragma teoz true
hide footbox
title Pago

actor "emp:Empleado" as emp
participant "cv:ControladorVentas" as cv
participant "vta:Venta" as vta
participant "«multiobjeto»\ndetalles:DetalleVenta" as lineas
participant "cc:<<Singleton>>\nCatalogoClientes" as cc
participant "listaC[i]:Cliente" as itemCli
participant "cli:Cliente" as cli
participant "cDesc:<<Singleton>>\nCatalogoDescuentos" as cDesc
participant "listaD[k]:TipoDescuento" as itemDesc
participant "desc:TipoDescuento" as descObj
participant "pago:Pago" as pagoObj
participant "sp:ServicioPagos" as sp
participant "catVta:<<Singleton>>\nCatalogoVentas" as catVta
participant "«multiobjeto»\nventas:Venta" as multiVentas
participant "tkt:Ticket" as ticket
participant "sc:ServicioCorreos" as correo

note over emp, correo
    Precondición: El empleado inicia el cierre de la venta.
end note

' ============================================================
' 1. CALCULAR TOTAL BRUTO
' ============================================================
cv -> vta : calcularTotal()
activate vta
    loop para cada d en detalles
        vta -> lineas : getSubtotal()
        activate lineas
        lineas --> vta : <<subtotal : Decimal>>
        deactivate lineas
    end
    vta --> cv : <<total : Decimal>>
deactivate vta

cv -> vta : setTotal(total : Decimal)
activate vta
vta --> cv : <<NULL>>
deactivate vta

' ============================================================
' 2. APLICAR REGLAS (Descuentos o Recargos)
' ============================================================

alt medioPago == EFECTIVO
    ' RAMA A: EFECTIVO -> Posible Descuento
    cv -> vta : getClienteDNI()
    activate vta
    vta --> cv : <<dniVenta : INT>>
    deactivate vta

    cv -> cc : buscarCliente(dniVenta : INT)
    activate cc
    loop hasta dniEncontrado == dniVenta
        cc -> itemCli : getDNI()
        activate itemCli
        itemCli --> cc : <<dni : INT>>
        deactivate itemCli
    end
    cc --> cv : <<cli : Object Type : Cliente>>
    deactivate cc

    cv -> cli : getesFrecuente()
    activate cli
    cli --> cv : <<esFrecuente : BOOL>>
    deactivate cli

    alt esFrecuente == TRUE
        cv -> cDesc : buscarDescuento("Cliente Frecuente")
        activate cDesc
        loop hasta motivo == "Cliente Frecuente"
            cDesc -> itemDesc : getMotivo()
            activate itemDesc
            itemDesc --> cDesc : <<motivo : String>>
            deactivate itemDesc
        end
        cDesc --> cv : <<descObj : Object Type : TipoDescuento>>
        deactivate cDesc

        cv -> descObj : getPorcentaje()
        activate descObj
        descObj --> cv : <<porc : Decimal>>
        deactivate descObj

        note right of cv
            nuevoTotal = total - (total * porc / 100)
        end note

        cv -> vta : setTotal(nuevoTotal : Decimal)
        activate vta
        vta --> cv : <<NULL>>
        deactivate vta
    end

else medioPago == TARJETA
    ' RAMA B: TARJETA -> Posible Recargo (> 3 cuotas)
    alt cuotas > 3
        note right of cv
            recargo = total * (0.20 * (cuotas - 3))
            totalConRecargo = total + recargo
        end note

        cv -> vta : setTotal(totalConRecargo : Decimal)
        activate vta
        vta --> cv : <<NULL>>
        deactivate vta
    else cuotas < 3
        cv -> vta : setTotal(total : Decimal)
        activate vta
        vta --> cv : <<NULL>>
        deactivate vta
    end
end

' ============================================================
' 3. REGISTRAR PAGO (Instanciar + Procesar)
' ============================================================
cv -> vta : getTotal()
activate vta
vta --> cv : <<montoFinal : Decimal>>
deactivate vta

' A) Creamos la entidad Pago (Registro interno)
create pagoObj
cv -> pagoObj : CrearPago(vta : Object Type : Venta, medioPago : String, montoFinal : Decimal, cuotas : INT)
activate pagoObj
pagoObj --> cv : <<pagoObj : Object Type : Pago>>
deactivate pagoObj

' B) Llamamos al servicio externo (POS/Banco)
cv -> sp : procesarPago(PagoObj : Object Type : Pago)
activate sp
sp --> cv : <<estadoPago : Enum>>
deactivate sp

' C) Actualizamos la entidad Pago con el resultado
cv -> pagoObj : setEstado(estadoPago)
activate pagoObj
pagoObj --> cv : <<NULL>>
deactivate pagoObj

alt estadoPago == aprobado
    
    ' Simulamos que el servicio nos devuelve un nroTransaccion (aunque el método
    ' en V5.2 no lo retorna explícitamente, es lógico setearlo si el pago pasa).
    ' Asumimos que se obtiene del contexto del servicio.
    cv -> sp : confirmarTransaccion(nroVta : INT) 
    activate sp
    sp --> cv : <<numTicketPos : INT>>
    deactivate sp

    cv -> pagoObj : setNumTransaccion(numTicketPos : INT)
    activate pagoObj
    pagoObj --> cv : <<NULL>>
    deactivate pagoObj

    ' D) Finalizar Venta
    cv -> vta : setEstadoVenta(Concretado)
    activate vta
    vta --> cv : <<NULL>>
    deactivate vta

    ' Registrar en Catálogo
    cv -> catVta : registrarVenta(vta : Object Type : Venta)
    activate catVta
    catVta -> multiVentas : agregar(vta : Object Type : Venta)
    activate multiVentas
    multiVentas --> catVta : <<NULL>>
    deactivate multiVentas
    catVta --> cv : <<NULL>>
    deactivate catVta

    ' Ticket
    create ticket
    cv -> ticket : CrearTicket(vta : Object Type : Venta)
    activate ticket
    ticket --> cv : <<tkt : Object Type : Ticket>>
    deactivate ticket
    
    ' ============================================================
    ' 4. ENVÍO DE COMPROBANTE
    ' ============================================================
    cv -> vta : getClienteDNI()
    activate vta
    vta --> cv : <<dniC : INT>>
    deactivate vta
    
    cv -> cli : getEmail()
    activate cli
    cli --> cv : <<email : String>>
    deactivate cli
    
    cv -> cli : getNumTel()
    activate cli
    cli --> cv : <<tel : String>>
    deactivate cli
    
    cv -> correo : enviarTicketDigital(tkt : Object Type : Ticket, email : String, tel : String)
    activate correo
    correo --> cv : <<NULL>>
    deactivate correo

    cv --> emp : "Venta Finalizada Exitosamente"
else estadoPago == Rechazado
    cv --> emp : "Error: Pago Rechazado"
end

deactivate cv
@enduml