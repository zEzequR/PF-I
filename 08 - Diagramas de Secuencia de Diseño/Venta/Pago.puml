@startuml
title Proceso de Pago: Validación, Cuenta Corriente, Estados y Reintentos

hide footbox

actor "Empleado" as emp
participant "Interfaz: NegCtrl" as NegCtrl
participant "Venta: objVenta" as venta
participant "Cliente: objCliente" as cli
participant "Pago: objPago" as pago
participant "ServicioPagos: ExtSrv" as srvPagos
participant "DetalleVenta: det" as det
participant "Medicamento: med" as med
participant "Ticketera" as printer
participant "ServicioCorreos: ExtSrv" as mailer

emp -> NegCtrl : iniciarPago()
activate NegCtrl

loop Mientras la venta esté PENDIENTE
    
    emp -> NegCtrl : ingresarMedioPago(medio, cuotas)
    
    ' Actualizar monto final según medio (Recargos/Descuentos)
    NegCtrl -> venta : calcularMontoFinal(medio, cuotas)
    activate venta
    venta --> NegCtrl : << montoFinal >>
    deactivate venta

    alt medio == "Cuenta Corriente"
        
        NegCtrl -> cli : esFrecuente()
        activate cli
        cli --> NegCtrl : << esFrecuente : Bool >>
        deactivate cli
        
        NegCtrl -> cli : getSaldoDisponible()
        activate cli
        cli --> NegCtrl : << saldoDisponible : Float >>
        deactivate cli

        alt esFrecuente AND saldoDisponible >= montoFinal
             NegCtrl -> cli : actualizarSaldo(montoFinal)
             activate cli
             cli --> NegCtrl : <<NULL>>
             deactivate cli
             
             NegCtrl -> venta : registrarPago(montoFinal, "Cta Cte")
             activate venta
                 venta -> pago ** : create(montoFinal, "Cta Cte")
                 activate pago
                 pago --> venta : << objPago >>
                 deactivate pago
             venta --> NegCtrl : <<NULL>>
             deactivate venta
             
        else Error: No es frecuente o Saldo insuficiente
             NegCtrl --> emp : <<Error: Cliente no apto o sin cupo>>
             NegCtrl -> NegCtrl : pagoExitoso = false
        end

    else Medio Externo (Tarjeta/QR/Billetera Virtual)
        
        NegCtrl -> venta : validarReglasPago(medio, cuotas)
        activate venta
        venta --> NegCtrl : << esValido : Bool >>
        deactivate venta

        alt esValido == true
            NegCtrl -> srvPagos : iniciarTransaccion(montoFinal, medio, cuotas)
            activate srvPagos
            srvPagos --> NegCtrl : << estadoTransaccion : String >>
            deactivate srvPagos

            alt estadoTransaccion == "APROBADA"
                
                NegCtrl -> venta : registrarPago(montoFinal, medio)
                activate venta
                    venta -> pago ** : create(montoFinal, medio)
                    activate pago
                    
                    pago --> venta : << objPago >>
                    deactivate pago
                venta --> NegCtrl : <<NULL>>
                deactivate venta
            
            else RECHAZADA
                 NegCtrl --> emp : <<Error: Transacción Rechazada>>
            end
        else Reglas Violadas
             NegCtrl --> emp : <<Error: Medio no permitido por reglas>>
        end
    end

    alt pagoExitoso == true
        
        NegCtrl -> venta : setEstado("CONFIRMADA")
        activate venta
        venta --> NegCtrl : <<NULL>>
        deactivate venta

        NegCtrl -> venta : actualizarStock()
        activate venta
             loop para cada detalle
                 venta -> det : descontarStock()
                 activate det
                 det -> med : actualizarStock(cantidad)
                 activate med
                 med --> det : <<NULL>>
                 deactivate med
                 det --> venta : <<NULL>>
                 deactivate det
             end
        venta --> NegCtrl : <<NULL>>
        deactivate venta

        NegCtrl -> printer : imprimirTicket(objVenta)
        activate printer
        printer --> NegCtrl : << exito : Boolean >>
        deactivate printer
        
        opt exito == false
            NegCtrl -> mailer : enviarTicket(objVenta, cli.getEmail())
            activate mailer
            deactivate mailer
        end

        NegCtrl --> emp : <<Venta Finalizada>>

    else pagoExitoso == false
        
        opt Cancelar Operación (Salir del bucle)
            emp -> NegCtrl : cancelarVenta()
            
            NegCtrl -> venta : setEstado("CANCELADA")
            activate venta
            venta --> NegCtrl : <<NULL>>
            deactivate venta
            
            NegCtrl --> emp : <<Venta Cancelada>>
        end
    end

end

deactivate NegCtrl
@enduml