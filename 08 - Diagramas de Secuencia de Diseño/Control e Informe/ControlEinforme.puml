@startuml
title Control e Informe: Reportes y Pedidos

hide footbox

actor "Administrador" as admin
participant "NegocioControlador" as NegCtrl
participant "List<Venta>: catalogoVentas" as listaVtas
participant "Venta: v" as vta
participant "List<Medicamento>: catalogoMeds" as listaMed
participant "Medicamento: m" as med
participant "List<Drogueria>: catalogoDrogs" as listaDrogs
participant "Drogueria: d" as drog
participant "ServicioExterno" as srv

admin -> NegCtrl : accederModuloControl()
activate NegCtrl
NegCtrl --> admin : << Vista Control >>
deactivate NegCtrl

' --- INICIO DE SELECCIÓN ---
admin -> NegCtrl : seleccionarReporte(tipo: String, filtros: Map)
activate NegCtrl

alt tipo == "Informe Ventas"

    NegCtrl -> listaVtas : filtrarVentas(filtros)
    activate listaVtas
    
    loop para cada v en catalogoVentas
        listaVtas -> vta : getFecha()
        activate vta
        vta --> listaVtas : << date : fechaVenta >>
        deactivate vta
        
        ' La lógica de filtrado es interna en el bucle
    end
    
    listaVtas --> NegCtrl : << List<Ventas> : listaVentasFiltrada >>
    deactivate listaVtas

    NegCtrl --> admin : << Muestra Tabla >>

    ' --- EXPORTAR ---
    admin -> NegCtrl : exportarInforme("PDF")
    
    NegCtrl -> srv : generarPDFVentas(listaVentasFiltrada)
    activate srv
    srv --> NegCtrl : << File : archivoPDF >>
    deactivate srv


else tipo == "Control Stock / Pedido"

    ' --- BUSCAR BAJO STOCK ---
    NegCtrl -> listaMed : obtenerBajoStock()
    activate listaMed
    
    loop para cada m en catalogoMeds
        listaMed -> med : getStock()
        activate med
        med --> listaMed : << Int : stockActual >>
        deactivate med

        listaMed -> med : getStockMinimo()
        activate med
        med --> listaMed : << Int : stockMin >>
        deactivate med
    end
    
    listaMed --> NegCtrl : << List<Medicamento> : listaReposicion >>
    deactivate listaMed

    NegCtrl --> admin : << Muestra Tabla Bajo Stock >>

    ' --- PROCESO DE PEDIDO ---
    admin -> NegCtrl : confirmarPedido(items, nombreDrogueria)
    
    ' 1. BUSCAR PROVEEDOR
    NegCtrl -> listaDrogs : buscarDrogueria(nombreDrogueria)
    activate listaDrogs
    
    loop para cada d en catalogoDrogs
        listaDrogs -> drog : getNombre()
        activate drog
        drog --> listaDrogs : << String : nombreActual >>
        deactivate drog
        
        alt nombreActual == nombreDrogueria
             listaDrogs --> NegCtrl : << Object :objDrog >>
             break
        end
    end
    deactivate listaDrogs

    ' 2. OBTENER DATOS
    NegCtrl -> drog : getCanalPreferido()
    activate drog
    drog --> NegCtrl : << canal >>
    deactivate drog
    
    NegCtrl -> drog : getEmail()
    activate drog
    drog --> NegCtrl : << email >>
    deactivate drog
    
    NegCtrl -> drog : getTelefono()
    activate drog
    drog --> NegCtrl : << telefono >>
    deactivate drog

    ' 3. GENERAR
    NegCtrl -> srv : generarPDFPedido(items, objDrog)
    activate srv
    srv --> NegCtrl : << pdfPedido >>
    deactivate srv

    ' 4. ENVIAR SEGUN CANAL
    alt canal == "WhatsApp"
        NegCtrl -> srv : enviarWhatsApp(pdfPedido, telefono)
        activate srv
        srv --> NegCtrl : << resultadoEnvio >>
        deactivate srv
        
    else canal == "Email"
        NegCtrl -> srv : enviarCorreo(pdfPedido, email)
        activate srv
        srv --> NegCtrl : << resultadoEnvio >>
        deactivate srv

    end

    ' 5. VALIDAR RESULTADO
    alt resultadoEnvio == FALSE
        NegCtrl -> srv : guardarArchivoLocal(pdfPedido, rutaBackup)
        activate srv
        srv --> NegCtrl : << OK >>
        deactivate srv
        NegCtrl --> admin : << Error envio. Guardado Local >>
    else
        NegCtrl --> admin : << Pedido Enviado >>
    end

end

deactivate NegCtrl
@enduml